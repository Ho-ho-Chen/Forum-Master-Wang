<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Mirror AI - V16.0 Domineering</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šé»‘é‡‘ç´…éœ¸æ°£é¢¨æ ¼ */
        :root { --bg-color: #000000; --panel-bg: #1a1a1a; --accent-color: #FFD700; /* é‡‘è‰² */ --power-color: #ff3333; /* ç´…è‰²å¼·èª¿ */ --text-primary: #ffffff; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; flex: none; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 10px; color: var(--accent-color); }
        .version-tag { font-size: 10px; background: var(--power-color); padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .viewport { width: 100%; aspect-ratio: 3/4; background: #000; border-radius: 16px; border: 2px solid #444; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex: none; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        video, img { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        /* V15 ç´°ç¯€æ§åˆ¶å° (ä¿ç•™) */
        .control-panel { width: 100%; background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        .panel-title { font-size: 14px; color: var(--accent-color); margin-bottom: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .select-group { display: flex; flex-direction: column; gap: 5px; }
        .select-label { font-size: 11px; color: #888; margin-left: 2px; }
        select.detail-select { width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 13px; outline: none; appearance: none; }
        select.detail-select:focus { border-color: var(--accent-color); }

        /* é®ç½©å±¤ */
        #start-overlay, #question-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        #question-overlay { display: none; z-index: 1000; border: 3px solid var(--power-color); } /* å¢åŠ ç´…æ¡†å¼·èª¿ */

        .btn-action { width: 80%; padding: 14px 0; border-radius: 50px; border: none; background: var(--accent-color); color: black; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .btn-secondary { background: #333; border: 1px solid #555; margin-top: 15px; color: white; box-shadow: none; }
        .btn-power { background: var(--power-color); color: white; box-shadow: 0 0 20px rgba(255, 51, 51, 0.4); } /* ç´…è‰²å¼·åŠ›æŒ‰éˆ• */
        
        select.camera-select { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 12px; font-size: 16px; outline: none; }
        
        /* é¢¨æ ¼ Grid */
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; padding-bottom: 40px;}
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 12px 5px; cursor: pointer; text-align: center; font-size: 15px; position: relative; overflow: hidden; transition: all 0.2s; }
        .style-card:active { transform: scale(0.96); background: #444; }
        .style-real { border-color: var(--accent-color); }
        .style-tao { border-color: #ffffff; background: linear-gradient(45deg, #2a2a2a, #555); }

        .gender-toggle { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 10px; background: #333; border-radius: 10px; border: 1px solid #555; cursor: pointer; font-weight: bold; color: #888; font-size: 15px; }
        .gender-option.selected { background: var(--accent-color); color: black; font-weight: bold; }
        
        /* å½ˆå‡ºæ–‡å­—å‹•ç•« */
        .pop-text { font-size: 20px; line-height: 1.6; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight: bold; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .highlight-name { color: var(--accent-color); font-size: 32px; border-bottom: 3px solid var(--power-color); display: inline-block; margin: 10px 0; }

        #canvas { display: none; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V16.0 éœ¸æ°£ç‰ˆ</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:20px;">V16.0 å°æ¼”/å£‡ä¸»æ¨¡å¼</p>
        <div id="step-permission" style="width:100%; display:flex; justify-content:center;">
            <button class="btn-action" onclick="firstStart()">ğŸš€ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div id="step-selection" style="display:none; width:100%;">
            <p style="color:white; margin-bottom:15px;">å·²åµæ¸¬åˆ°ç›¸æ©Ÿï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="startSpecificCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: var(--power-color); font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>

    <div id="question-overlay">
        <div id="q-step-1">
            <h1 style="font-size: 60px; margin-bottom: 5px;">ğŸ¦</h1>
            <h2 style="color: var(--power-color); margin-bottom: 15px; font-size: 28px; text-transform: uppercase;">æ…¢è‘—ï¼æœ‰æƒ…æ³ï¼</h2>
            <p class="pop-text" style="color: #ddd; margin-bottom: 30px; text-align: left; padding: 0 20px;">
                æœ¬ç³»çµ±åµæ¸¬åˆ°ä¸€è‚¡éæ¯”å°‹å¸¸çš„<b style="color:var(--accent-color);">å¼·å¤§æ°£å ´</b>ç›´è¡é›²éœ„ï¼<br><br>
                æœ‰é€™ç¨®é­„åŠ›èˆ‡æ“”ç•¶çš„...<br>
                è«éä½ å°±æ˜¯é‚£ä½å‚³èªªä¸­çš„å£‡ä¸»â€”â€”<br>
                <center><b class="highlight-name">ç‹æŒ¯èˆˆ</b> æœ¬äººï¼Ÿï¼</center>
                <br>å¾å¯¦æ‹›ä¾†ï¼
            </p>
            <button class="btn-action btn-power" onclick="answerQuestion(true)">ğŸ‘Š å“ˆå“ˆå“ˆï¼æœç„¶æ˜¯ä½ ï¼(æ˜¯æœ¬äºº)</button>
            <button class="btn-action btn-secondary" onclick="answerQuestion(false)">âœ‹ å“¦ï¼ŸèªéŒ¯äººäº†ï¼Ÿ(ä¸æ˜¯)</button>
        </div>
        <div id="q-step-2" style="display:none;">
            <h1 style="font-size: 50px; margin-bottom: 10px;">ğŸ”¥</h1>
            <h2 style="color: var(--accent-color); margin-bottom: 15px;">æœ€é«˜è¦æ ¼ä¼ºå€™ï¼</h2>
            <p id="praise-text" class="pop-text" style="color: #ddd; margin-bottom: 30px; text-align: left; padding: 0 20px;">
                </p>
            <div style="width:80%; height:8px; background:#333; margin: 0 auto; border-radius:4px; border: 1px solid var(--accent-color);">
                <div id="praise-bar" style="width:0%; height:100%; background:var(--power-color); transition:width 2s;"></div>
            </div>
            <p style="color:var(--accent-color); font-size:14px; margin-top:15px; font-weight: bold;">AI è½ä»¤ï¼å…¨é€Ÿé‹è½‰ï¼Œä¸å¾—æœ‰èª¤ï¼</p>
        </div>
    </div>

    <div id="stage-1" class="stage">
        <div class="viewport">
            <video id="webcam" playsinline class="mirror" autoplay></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[åˆ‡æ›é¡é ­]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport" style="width: 140px; height: 140px; border-radius: 50%; border-color: var(--accent-color); margin-top: 5px;">
            <img id="preview-img" class="mirror" src="">
        </div>
        
        <div class="gender-toggle">
            <div class="gender-option" onclick="selectGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
            <div class="gender-option selected" onclick="selectGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
        </div>

        <div class="control-panel">
            <div class="panel-title">ğŸ¬ å°æ¼”æŒ‡ä»¤ï¼šç´°ç¯€è¨­å®š</div>
            <div class="select-grid">
                <div class="select-group"><span class="select-label">ğŸ‘— æœè£</span><select id="opt-clothes" class="detail-select"><option value="">(é è¨­)</option><option value="wearing white hanfu">æ¼¢æœ/å¤è£</option><option value="wearing business suit">è¥¿è£/å¥—è£</option><option value="wearing qipao dress">æ——è¢</option><option value="wearing casual t-shirt">ä¼‘é–’ Tæ¤</option><option value="wearing cyberpunk armor">ç§‘æŠ€æˆ°ç”²</option></select></div>
                <div class="select-group"><span class="select-label">ğŸ’‡ é«®å‹</span><select id="opt-hair" class="detail-select"><option value="">(é è¨­)</option><option value="long curly hair">é•·æ²é«®</option><option value="short hair">ä¿éº—çŸ­é«®</option><option value="ponytail">é¦¬å°¾</option><option value="straight long hair">é»‘é•·ç›´</option><option value="short spikey hair">å¸¥æ°£åˆºèŸé ­</option></select></div>
                <div class="select-group"><span class="select-label">ğŸ‘‘ é ­é£¾</span><select id="opt-headwear" class="detail-select"><option value="">(ç„¡)</option><option value="wearing glasses">çœ¼é¡</option><option value="wearing a flower hairpin">èŠ±æœµé«®ç°ª</option><option value="wearing a crown">çš‡å† </option><option value="wearing headphones">è€³æ©Ÿ</option><option value="wearing a baseball cap">æ£’çƒå¸½</option></select></div>
                <div class="select-group"><span class="select-label">ğŸ¤² æ‰‹æŒç‰©å“</span><select id="opt-held" class="detail-select"><option value="">(ç„¡)</option><option value="holding a book">æ‹¿è‘—æ›¸</option><option value="holding a lotus flower">æ‹¿è‘—è“®èŠ±</option><option value="holding a sword">æ‹¿è‘—åŠ</option><option value="holding a coffee cup">æ‹¿è‘—å’–å•¡</option><option value="holding a fan">æ‹¿è‘—æ‰‡å­</option></select></div>
                <div class="select-group"><span class="select-label">ğŸ“ åœ°é»</span><select id="opt-location" class="detail-select"><option value="">(éš¨æ©Ÿ)</option><option value="in a forest">æ£®æ—</option><option value="at the beach">æµ·é‚Š</option><option value="in a cyberpunk city">æœªä¾†åŸå¸‚</option><option value="in an ancient temple">å¤è€å»Ÿå®‡</option><option value="in a classroom">æ•™å®¤</option><option value="in outer space">å¤–å¤ªç©º</option></select></div>
                <div class="select-group"><span class="select-label">ğŸŒ¤ï¸ å¤©æ°£/æ°›åœ</span><select id="opt-weather" class="detail-select"><option value="">(éš¨æ©Ÿ)</option><option value="sunny day, bright lighting">é™½å…‰ç‡¦çˆ›</option><option value="raining, cinematic lighting">ä¸‹é›¨é›»å½±æ„Ÿ</option><option value="starry night">æ˜Ÿç©ºå¤œæ™š</option><option value="sunset, golden hour">é»ƒæ˜é‡‘å…‰</option><option value="foggy, mysterious">éœ§æ°£ç¥ç§˜</option></select></div>
            </div>
        </div>

        <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:10px;">ç¢ºèªç•«é¢¨ (è§¸ç™¼æ””æˆª)ï¼š</h3>
        <div class="style-grid">
            <div class="style-card style-real" onclick="triggerTrap('real')">ğŸ“¸ çœŸäººæ“¬çœŸ</div>
            <div class="style-card style-tao" onclick="triggerTrap('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
            <div class="style-card" onclick="triggerTrap('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
            <div class="style-card" onclick="triggerTrap('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
            <div class="style-card" onclick="triggerTrap('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
            <div class="style-card" onclick="triggerTrap('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
            <div class="style-card" onclick="triggerTrap('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
            <div class="style-card" onclick="triggerTrap('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
        </div>
        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:15px;" onclick="location.reload()">â¬…ï¸ é‡æ‹</button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2>âš¡ AI å°æ¼”é–‹æ‹ä¸­...</h2>
        <div style="width:70%; height:6px; background:#333; margin-top:20px; border-radius:3px;">
            <div id="progress-bar" style="width:0%; height:100%; background:var(--accent-color); transition:width 0.3s;"></div>
        </div>
        <p id="prompt-debug" style="color:#666; font-size:12px; margin-top:15px; max-width:80%; text-align:center;">Loading...</p>
    </div>

    <div id="stage-4" class="stage">
        <h2>âœ¨ æ‚¨çš„æ•¸ä½å¤§ç‰‡</h2>
        <div class="viewport">
            <img id="final-result" src="">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 18px; margin-top: 5px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background:#333; color:white; font-size:16px; margin-top: 20px;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), canvas = document.getElementById('canvas'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    let currentGender = 'girl'; 
    let pendingStyle = ''; // æš«å­˜é¢¨æ ¼

    async function firstStart() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('step-permission').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) { errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼š" + err.message + "\nè«‹ç”¨ Chrome é–‹å•Ÿ"; }
    }
    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­";
            else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label;
            cameraList.appendChild(option);
        });
    }
    async function startSpecificCamera() {
        const deviceId = cameraList.value;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
            video.srcObject = stream;
            document.getElementById('start-overlay').style.display = 'none';
            switchStage('stage-1');
        } catch (err) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('start-overlay').style.display = 'none';
                switchStage('stage-1');
            } catch (fatalErr) { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ"); }
        }
    }
    function selectGender(g) { currentGender = g; document.getElementById('btn-boy').classList.toggle('selected', g==='boy'); document.getElementById('btn-girl').classList.toggle('selected', g==='girl'); }
    function capturePhoto() {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d'); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        previewImg.src = canvas.toDataURL('image/png'); switchStage('stage-2');
    }

    function getDetails() {
        const ids = ['opt-clothes', 'opt-hair', 'opt-headwear', 'opt-held', 'opt-location', 'opt-weather'];
        let details = [];
        ids.forEach(id => { const val = document.getElementById(id).value; if(val) details.push(val); });
        return details.join(", ");
    }

    // ============================================
    // V16.0 éœ¸æ°£æ””æˆªæ©Ÿåˆ¶
    // ============================================
    function triggerTrap(styleKey) {
        pendingStyle = styleKey; 
        document.getElementById('question-overlay').style.display = 'flex';
        document.getElementById('q-step-1').style.display = 'block';
        document.getElementById('q-step-2').style.display = 'none';
    }

    function answerQuestion(isHim) {
        document.getElementById('q-step-1').style.display = 'none';
        document.getElementById('q-step-2').style.display = 'block';
        
        const textEl = document.getElementById('praise-text');
        
        if (isHim) {
            // å›ç­”ã€Œæ˜¯æœ¬äººã€: éœ¸æ°£ç¢ºèª
            textEl.innerHTML = "<b>å“ˆå“ˆå“ˆï¼æœç„¶æ˜¯ä½ ï¼</b><br>ç‹å£‡ä¸»ï¼Œä¹…ä»°å¤§åï¼<br>æ—¢ç„¶æœ¬å°Šé™è‡¨ï¼Œé‚£é‚„æœ‰ä»€éº¼å¥½èªªçš„ï¼Ÿ<br>é€™ä»½éœ¸æ°£èˆ‡æ“”ç•¶ï¼ŒAI å‹™å¿…å®Œç¾å‘ˆç¾ï¼<br><b>ä¾†çœ‹æˆå“ï¼</b>";
        } else {
            // å›ç­”ã€Œä¸æ˜¯ã€: éœ¸æ°£åé§
            textEl.innerHTML = "<b>å“¼ï¼Œå°‘é¨™æˆ‘äº†ï¼</b><br>é€™è‚¡ä¸æ€’è‡ªå¨çš„ã€Œå£‡ä¸»ç´šã€æ°£å‹¢ï¼Œ<br>æ™®é€šäººå“ªæ‰¿æ“”å¾—èµ·ï¼Ÿ<br>å°±ç®—ä½ ç¾åœ¨ä¸æ˜¯ï¼Œå°‡ä¾†ä¹Ÿå¿…æˆå¤§å™¨ï¼<br><b>å»¢è©±å°‘èªªï¼Œç…§æ¨£æœ€é«˜è¦æ ¼ä¼ºå€™ï¼</b>";
        }

        const bar = document.getElementById('praise-bar');
        setTimeout(() => { bar.style.width = '100%'; }, 100);

        // 3.5ç§’å¾Œé–‹å§‹ç”Ÿæˆ
        setTimeout(() => {
            document.getElementById('question-overlay').style.display = 'none';
            realGenerate();
        }, 3500);
    }

    // çœŸæ­£çš„ç”Ÿæˆå‡½å¼ (åŒ…å« V15 çš„ç´°ç¯€è¨­å®š)
    function realGenerate() {
        switchStage('stage-3'); 
        simulateProgress();

        let styleKey = pendingStyle;
        // V16 å¼·åˆ¶è¨­å®šï¼šç„¡è«–ä»‹é¢é¸ä»€éº¼æ€§åˆ¥ï¼Œå› ç‚ºæ˜¯å£‡ä¸»ï¼Œé€™è£¡å¼·åˆ¶ç”¨ç”·æ€§åŸºåº•ï¼Œä½†ä¿ç•™ä½¿ç”¨è€…é¸çš„ç´°ç¯€
        // å¦‚æœæ‚¨å¸Œæœ›ä¿ç•™ä»‹é¢é¸æ“‡çš„æ€§åˆ¥ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸‹é¢é€™è¡Œï¼Œä¸¦è¨»è§£æ‰å†ä¸‹é¢é‚£è¡Œ
        // let genderBase = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female";
        let genderBase = "handsome man, male, dignified aura"; // å¼·åˆ¶ç”·æ€§å£‡ä¸»æ°£å ´

        let detailPrompt = getDetails(); // ç²å–å°æ¼”è¨­å®š
        let fullPrompt = "";
        
        if(styleKey === 'pixar')    fullPrompt = `cute 3d pixar style ${genderBase}, ${detailPrompt}, studio lighting, big eyes, 8k`;
        else if(styleKey === 'ghibli')   fullPrompt = `studio ghibli anime portrait of ${genderBase}, ${detailPrompt}, hayao miyazaki style, watercolor background`;
        else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait of ${genderBase}, ${detailPrompt}, neon lights, mechanical parts, futuristic city`;
        else if(styleKey === 'oil')      fullPrompt = `van gogh oil painting portrait of ${genderBase}, ${detailPrompt}, thick brushstrokes, artistic, starry night`;
        else if(styleKey === 'comic')    fullPrompt = `american comic superhero ${genderBase}, ${detailPrompt}, bold lines, halftone dots, marvel style`;
        else if(styleKey === 'ink')      fullPrompt = `chinese ink wash painting portrait of ${genderBase}, ${detailPrompt}, black and white, sumi-e, artistic, red stamp`;
        else if(styleKey === 'real')     fullPrompt = `(masterpiece), best quality, realistic photo of a ${genderBase}, ${detailPrompt}, highly detailed face, dslr, 8k, raw photo, soft lighting, looking at camera`;
        else if(styleKey === 'taoist')   fullPrompt = `(masterpiece), traditional chinese ancient style portrait of ${genderBase}, ${detailPrompt}, wearing rich robes, righteous aura, temple hall background, majestic, soft lighting, hd, 8k`;

        document.getElementById('prompt-debug').innerText = "AI æ­£åœ¨åŸ·è¡Œå£‡ä¸»æŒ‡ä»¤ï¼š" + (detailPrompt ? detailPrompt : "éœ¸æ°£å¤–éœ²") + " ...";

        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=1024&height=1024&seed=${Math.floor(Math.random()*9999)}&nologo=true`;

        const img = new Image();
        img.onload = () => { finalImg.src = aiUrl; document.getElementById("qrcode-container").innerHTML = ""; new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); switchStage('stage-4'); };
        img.onerror = () => { alert("AI å¿™ç¢Œä¸­ï¼Œè«‹é‡è©¦"); location.reload(); };
        img.src = aiUrl;
    }

    function simulateProgress() { const bar = document.getElementById('progress-bar'); let w = 0; const int = setInterval(() => { if(w>=90) clearInterval(int); w+=10; bar.style.width=w+'%'; }, 300); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>